<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Crew Rest Calculator — Single File Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 18px; color: #111; }
    h1 { margin-top: 0; }
    label { display: block; margin-top: 10px; font-weight: 600; }
    input, select { padding: 6px 8px; margin-top: 6px; width: 100%; max-width: 360px; box-sizing: border-box; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .small { width:140px; }
    .tiny { width:80px; }
    button { margin-top: 12px; padding: 8px 14px; }
    .result { margin-top: 18px; padding: 12px; border: 1px solid #ddd; background: #fafafa; max-width: 900px; }
    .note { color: #555; font-size: 0.95rem; margin-top: 8px; }
    pre { background:#111;color:#eee;padding:12px; overflow:auto; }
    table { border-collapse: collapse; margin-top:12px; }
    td, th { border:1px solid #ddd; padding:8px; text-align:left; }
    .warn { color: #a33; font-weight:700; }
    .ok { color: #166; font-weight:700; }
    .inline-note { font-weight:400; margin-left:8px; color:#333; }
    .readonly { background:#f5f5f5; border:1px solid #e2e2e2; padding:6px 8px; }
  </style>
</head>
<body>
  <h1>Crew Rest Calculator — Demo (single file)</h1>
  <p>Enter inputs, press "Compute schedule". All times displayed in destination local time (12-hour AM/PM). This demo uses a small IATA→IANA mapping; if the airport isn't listed you can enter the IANA timezone manually.</p>

  <label>IATA code (or select) / Time zone &amp; destination local time
    <div class="row">
      <select id="iataSelect" style="width:180px">
        <option value="">-- pick sample --</option>
        <option value="LAX">LAX (Los Angeles)</option>
        <option value="JFK">JFK (New York)</option>
        <option value="LHR">LHR (London)</option>
        <option value="CDG">CDG (Paris)</option>
        <option value="FRA">FRA (Frankfurt)</option>
        <option value="SFO">SFO (San Francisco)</option>
        <option value="NRT">NRT (Tokyo Narita)</option>
        <option value="SYD">SYD (Sydney)</option>
        <option value="SIN">SIN (Singapore)</option>
      </select>

      <input id="iataInput" placeholder="IATA code (e.g. LAX) or leave blank" class="small" />
      <input id="tzInput" placeholder="IANA time zone (optional e.g. America/Los_Angeles)" class="small" />
      <div id="destNowDisplay" class="inline-note">Destination local time: —</div>
    </div>
  </label>

  <label>Touchdown time (destination local)
    <div class="row">
      <select id="tdHour" class="tiny"></select>
      <select id="tdMinute" class="tiny"></select>
      <select id="tdAmPm" class="tiny"><option>AM</option><option>PM</option></select>
      <input id="tdDate" type="date" class="small" />
      <label style="margin:0; font-weight:400;" class="inline-note">Default date = destination local day 6 hours from now. Default time = 4 hours from now.</label>
    </div>
  </label>

  <label>Break 1: minutes until start (from now)
    <div class="row">
      <input id="break1AfterNow" type="number" value="30" class="tiny" />
      <div id="break1StartDisplay" class="readonly inline-note">Break 1 start: —</div>
    </div>
  </label>

  <label>Number of groups (currently only 2 supported)
    <input id="groups" type="number" value="2" min="2" />
  </label>

  <label>Mid-service duration (minutes)
    <input id="midService" type="number" value="25" />
  </label>

  <div class="row">
    <label class="small">Buffer before mid-service (minutes)
      <input id="bufferBefore" type="number" value="5" />
    </label>
    <label class="small">Buffer after mid-service (minutes)
      <input id="bufferAfter" type="number" value="5" />
    </label>
  </div>

  <label>Landing service start: minutes before touchdown (default 90)
    <input id="landingOffset" type="number" value="90" />
  </label>

  <div style="margin-top:12px;">
    <button id="computeBtn">Compute schedule</button>
    <button id="exampleBtn">Fill example (LAX, TD 6:00 PM)</button>
  </div>

  <div id="output" class="result" aria-live="polite"></div>

<script>
(() => {
  // Small IATA -> IANA timezone mapping for demo
  const IATA_TZ = {
    LAX: 'America/Los_Angeles',
    SFO: 'America/Los_Angeles',
    JFK: 'America/New_York',
    ORD: 'America/Chicago',
    LHR: 'Europe/London',
    CDG: 'Europe/Paris',
    FRA: 'Europe/Berlin',
    NRT: 'Asia/Tokyo',
    HND: 'Asia/Tokyo',
    SYD: 'Australia/Sydney',
    SIN: 'Asia/Singapore'
  };

  const $ = id => document.getElementById(id);

  // Populate hour and minute selects
  function populateTimeSelectors() {
    const hour = $('tdHour');
    const minute = $('tdMinute');
    hour.innerHTML = '';
    minute.innerHTML = '';
    for (let h=1; h<=12; h++) {
      const opt = document.createElement('option'); opt.value = String(h); opt.textContent = String(h); hour.appendChild(opt);
    }
    for (let m=0; m<60; m+=1) {
      const opt = document.createElement('option'); opt.value = String(m).padStart(2,'0'); opt.textContent = String(m).padStart(2,'0'); minute.appendChild(opt);
    }
  }
  populateTimeSelectors();

  function setDestNowDisplay(tz, msUtc) {
    if (!tz) { $('destNowDisplay').textContent = 'Destination local time: —'; return; }
    const s = formatInZone(msUtc, tz);
    $('destNowDisplay').textContent = `Destination local time: ${s}`;
  }

  $('iataSelect').addEventListener('change', (e) => {
    const v = e.target.value;
    $('iataInput').value = v;
    if (IATA_TZ[v]) $('tzInput').value = IATA_TZ[v];
    onTimezoneChanged();
  });

  $('iataInput').addEventListener('change', onTimezoneChanged);
  $('tzInput').addEventListener('change', onTimezoneChanged);

  function onTimezoneChanged() {
    const iata = ($('iataInput').value || '').trim().toUpperCase();
    const tz = ($('tzInput').value || '').trim() || (IATA_TZ[iata] || '');
    if (!tz) { setDestNowDisplay(null); return; }
    const nowUtc = new Date();
    const destNowParts = getLocalParts(tz, nowUtc);
    const nowDestMs = localPartsToUtcMs(destNowParts);
    setDestNowDisplay(tz, nowDestMs);

    // Default touchdown date = date of (destNow + 6h)
    const defaultDateMs = nowDestMs + 6 * 3600 * 1000;
    const defaultDateStr = formatDateInputValue(defaultDateMs, tz);
    $('tdDate').value = defaultDateStr;

    // Default touchdown time selectors = time for (destNow + 4h)
    const defaultTdMs = nowDestMs + 4 * 3600 * 1000;
    const parts = getLocalParts(tz, new Date(defaultTdMs));
    let h = parseInt(parts.hour,10);
    let minutes = parseInt(parts.minute,10);
    let ampm = 'AM';
    if (h === 0) { h = 12; ampm = 'AM'; }
    else if (h === 12) { ampm = 'PM'; }
    else if (h > 12) { h = h - 12; ampm = 'PM'; }
    else { ampm = 'AM'; }
    $('tdHour').value = String(h);
    $('tdMinute').value = String(minutes).padStart(2,'0');
    $('tdAmPm').value = ampm;

    // Update Break1 start display
    updateBreak1StartDisplay();
  }

  // Utility: format msUtc in timezone into YYYY-MM-DD for date input value
  function formatDateInputValue(msUtc, tz) {
    const dtf = new Intl.DateTimeFormat('en-CA', { timeZone: tz, year: 'numeric', month: '2-digit', day: '2-digit' });
    return dtf.format(new Date(msUtc)); // en-CA gives YYYY-MM-DD
  }

  // Get parts (year,month,day,hour,minute,second) for a given timezone & date
  function getLocalParts(timeZone, date = new Date()) {
    const dtf = new Intl.DateTimeFormat('en-GB', {
      timeZone,
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit',
      hour12: false
    });
    const parts = dtf.formatToParts(date);
    const map = {};
    parts.forEach(p => { if (p.type !== 'literal') map[p.type] = p.value; });
    return {
      year: map.year,
      month: map.month,
      day: map.day,
      hour: map.hour,
      minute: map.minute,
      second: map.second
    };
  }

  // Given local parts for the time zone, produce the UTC ms timestamp that corresponds to that local wall time
  function localPartsToUtcMs(parts) {
    const s = `${parts.year}-${parts.month}-${parts.day}T${parts.hour}:${parts.minute}:${parts.second}Z`;
    return Date.parse(s);
  }

  // Format a UTC-ms timestamp in the specified timezone as 12-hour AM/PM string
  function formatInZone(msUtc, timeZone) {
    const dtf = new Intl.DateTimeFormat('en-US', {
      timeZone,
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: 'numeric', minute: '2-digit', hour12: true
    });
    return dtf.format(new Date(msUtc));
  }

  function parse12HourSelectors() {
    const hour = parseInt($('tdHour').value,10);
    const minute = parseInt($('tdMinute').value,10);
    const ampm = $('tdAmPm').value;
    let h24 = hour % 12;
    if (ampm === 'PM') h24 += 12;
    return { hour: h24, minute };
  }

  function show(msg) { $('output').innerHTML = msg; }

  $('exampleBtn').addEventListener('click', () => {
    $('iataSelect').value = 'LAX';
    $('iataInput').value = 'LAX';
    $('tzInput').value = IATA_TZ['LAX'];
    onTimezoneChanged();
    // set touchdown to 6:00 PM destination-local
    $('tdHour').value = '6';
    $('tdMinute').value = '00';
    $('tdAmPm').value = 'PM';
    $('break1AfterNow').value = 30;
    $('midService').value = 25;
    $('bufferBefore').value = 5;
    $('bufferAfter').value = 5;
    $('landingOffset').value = 90;
    updateBreak1StartDisplay();
  });

  // Update Break1 start display when break1AfterNow or timezone changes
  $('break1AfterNow').addEventListener('input', updateBreak1StartDisplay);
  $('tdHour').addEventListener('change', () => {});
  $('tdMinute').addEventListener('change', () => {});
  $('tdAmPm').addEventListener('change', () => {});
  $('tdDate').addEventListener('change', () => {});

  function updateBreak1StartDisplay() {
    const iata = ($('iataInput').value || '').trim().toUpperCase();
    const tz = ($('tzInput').value || '').trim() || (IATA_TZ[iata] || '');
    if (!tz) { $('break1StartDisplay').textContent = 'Break 1 start: —'; return; }
    const destNowParts = getLocalParts(tz, new Date());
    const nowDestMs = localPartsToUtcMs(destNowParts);
    const minutes = parseInt($('break1AfterNow').value || '0',10);
    const b1StartMs = nowDestMs + minutes * 60000;
    $('break1StartDisplay').textContent = `Break 1 start: ${formatInZone(b1StartMs, tz)} (local)`;
  }

  // Compute handler (core scheduling logic, preserving equal-rest shift behavior)
  $('computeBtn').addEventListener('click', run);

  function run() {
    const iata = ($('iataInput').value || '').trim().toUpperCase();
    const tzManual = ($('tzInput').value || '').trim();
    const tz = tzManual || (IATA_TZ[iata] || '');
    if (!tz) { show(`<div class="warn">Unknown timezone. Please enter a valid IANA timezone (e.g. America/Los_Angeles) or pick a known IATA code.</div>`); return; }

    const break1AfterNow = parseInt($('break1AfterNow').value || '0', 10);
    const groups = parseInt($('groups').value || '2', 10);
    if (groups !== 2) { show(`<div class="warn">This demo only supports 2 groups. Please set groups=2.</div>`); return; }
    const midService = Math.max(0, parseInt($('midService').value || '25', 10));
    const bufferBefore = Math.max(0, parseInt($('bufferBefore').value || '0', 10));
    const bufferAfter = Math.max(0, parseInt($('bufferAfter').value || '0', 10));
    let landingOffset = Math.max(0, parseInt($('landingOffset').value || '90', 10)); // minutes before touchdown

    const nowUtc = new Date();
    const destNowParts = getLocalParts(tz, nowUtc);
    const nowDestMs = localPartsToUtcMs(destNowParts);
    const nowDestStr = formatInZone(nowDestMs, tz);

    // Break 1 start (destination-local "now" plus break1AfterNow minutes)
    const b1StartMs = nowDestMs + break1AfterNow * 60000;

    // Touchdown from selectors and date
    const tdDateVal = $('tdDate').value; // YYYY-MM-DD
    const sel = parse12HourSelectors();
    if (!tdDateVal) { show(`<div class="warn">Please select a touchdown date.</div>`); return; }
    const m = tdDateVal.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) { show(`<div class="warn">Touchdown date invalid.</div>`); return; }
    const parts = { year: m[1], month: m[2], day: m[3], hour: String(sel.hour).padStart(2,'0'), minute: String(sel.minute).padStart(2,'0'), second: '00' };
    const touchdownMs = localPartsToUtcMs(parts);

    // If touchdown is earlier than nowDest and user selected date equal default, assume next day -- but here we assume user explicitly set date.

    // Landing service desired start (destination-local)
    let landingStartDesiredMs = touchdownMs - landingOffset * 60000;

    // Compute totals (in minutes)
    let T_total_min = Math.round((landingStartDesiredMs - b1StartMs) / 60000);
    const midservice_total = bufferBefore + midService + bufferAfter;
    let remainder = T_total_min - midservice_total; // minutes available for both rests combined
    let adjustments = { initialShift: 0, evenShift: 0 };

    // If not enough time, attempt to shift landing start later by the minimum minutes needed
    if (remainder < 0) {
      const required = -remainder; // minutes to add to landing start to make remainder zero
      let newLandingStartMs = landingStartDesiredMs + required * 60000;
      if (newLandingStartMs > touchdownMs) newLandingStartMs = touchdownMs;
      const newT_total_min = Math.round((newLandingStartMs - b1StartMs) / 60000);
      const newRemainder = newT_total_min - midservice_total;
      adjustments.initialShift = Math.round((newLandingStartMs - landingStartDesiredMs) / 60000);
      landingStartDesiredMs = newLandingStartMs;
      T_total_min = newT_total_min;
      remainder = newRemainder;
    }

    // If we have a non-negative remainder but it's odd, shift landing start later by 1 minute (if possible)
    if (remainder >= 0 && remainder % 2 !== 0) {
      const extraShift = 1; // minute
      let newLandingStartMs = landingStartDesiredMs + extraShift * 60000;
      if (newLandingStartMs <= touchdownMs) {
        landingStartDesiredMs = newLandingStartMs;
        adjustments.evenShift = extraShift;
        T_total_min = Math.round((landingStartDesiredMs - b1StartMs) / 60000);
        remainder = T_total_min - midservice_total;
      } else {
        // cannot shift to make even (would exceed touchdown)
        remainder = -1;
      }
    }

    // Check feasibility
    if (remainder < 0) {
      let msg = `<div class="warn">Not enough time between Break 1 start and touchdown (even after attempting to shift landing service). Please check inputs: reduce mid-service or buffers, start Break 1 earlier, or accept smaller landing service offset.</div>`;
      msg += `<div class="note">Summary of key times (destination local):</div>`;
      msg += `<table><tr><th>Event</th><th>Time</th></tr>`;
      msg += `<tr><td>Destination local "now"</td><td>${nowDestStr}</td></tr>`;
      msg += `<tr><td>Break 1 start (now + ${break1AfterNow} min)</td><td>${formatInZone(b1StartMs, tz)}</td></tr>`;
      msg += `<tr><td>Touchdown</td><td>${formatInZone(touchdownMs, tz)}</td></tr>`;
      msg += `<tr><td>Landing service desired start (before adj)</td><td>${formatInZone(touchdownMs - (landingOffset*60000), tz)}</td></tr>`;
      msg += `</table>`;
      show(msg);
      return;
    }

    // Now remainder is non-negative and even. Split exactly.
    const totalRestMinutes = remainder;
    const group1Rest = totalRestMinutes / 2;
    const group2Rest = totalRestMinutes / 2;

    // Build schedule
    const g1StartMs = b1StartMs;
    const g1EndMs = g1StartMs + group1Rest * 60000;
    const bufferBeforeStartMs = g1EndMs;
    const bufferBeforeEndMs = bufferBeforeStartMs + bufferBefore * 60000;
    const midStartMs = bufferBeforeEndMs;
    const midEndMs = midStartMs + midService * 60000;
    const bufferAfterStartMs = midEndMs;
    const bufferAfterEndMs = bufferAfterStartMs + bufferAfter * 60000;
    const g2StartMs = bufferAfterEndMs;
    const g2EndMs = g2StartMs + group2Rest * 60000;
    const landingStartMs = landingStartDesiredMs; // final value after adjustments
    const touchdownFinalMs = touchdownMs;

    // Render result
    let html = '';
    html += `<div><strong>Destination time zone:</strong> ${tz} (IATA ${iata || 'n/a'})</div>`;
    html += `<div><strong>Now at destination (local):</strong> ${nowDestStr}</div>`;
    if (adjustments.initialShift || adjustments.evenShift) {
      const totalShift = adjustments.initialShift + adjustments.evenShift;
      html += `<div class="note"><strong>Adjustment:</strong> Landing service start was shifted later by ${totalShift} minute(s) to allow exact equal rest durations. New landing-service start: ${formatInZone(landingStartMs, tz)} (was ${landingOffset} min before touchdown requested).</div>`;
    }
    html += `<table><tr><th>Event</th><th>Local time (${tz})</th><th>Duration / notes</th></tr>`;
    html += `<tr><td>Break 1 start</td><td>${formatInZone(g1StartMs, tz)}</td><td>Start of window</td></tr>`;
    html += `<tr><td>Group 1 rest</td><td>${formatInZone(g1StartMs, tz)} → ${formatInZone(g1EndMs, tz)}</td><td>${group1Rest} min</td></tr>`;
    html += `<tr><td>Buffer before mid-service</td><td>${formatInZone(bufferBeforeStartMs, tz)} → ${formatInZone(bufferBeforeEndMs, tz)}</td><td>${bufferBefore} min</td></tr>`;
    html += `<tr><td>Mid-service</td><td>${formatInZone(midStartMs, tz)} → ${formatInZone(midEndMs, tz)}</td><td>${midService} min</td></tr>`;
    html += `<tr><td>Buffer after mid-service</td><td>${formatInZone(bufferAfterStartMs, tz)} → ${formatInZone(bufferAfterEndMs, tz)}</td><td>${bufferAfter} min</td></tr>`;
    html += `<tr><td>Group 2 rest</td><td>${formatInZone(g2StartMs, tz)} → ${formatInZone(g2EndMs, tz)}</td><td>${group2Rest} min</td></tr>`;
    html += `<tr><td>Landing service start</td><td>${formatInZone(landingStartMs, tz)}</td><td>(requested ${landingOffset} min before touchdown)</td></tr>`;
    html += `<tr><td>Touchdown</td><td>${formatInZone(touchdownFinalMs, tz)}</td><td>Touchdown</td></tr>`;
    html += `</table>`;

    html += `<div class="note">Summary: total window from Break1 start → landing service start = <strong>${T_total_min} min</strong>. Midservice+buffers = <strong>${midservice_total} min</strong>. Total rest minutes available = <strong>${totalRestMinutes} min</strong> split equally into ${group1Rest} and ${group2Rest} minutes.</div>`;

    html += `<div class="ok">Schedule computed successfully. Both groups have identical rest durations.</div>`;

    // Provide printable "paper form" layout (simple)
    html += `<h3>Printable form (fill out on paper)</h3>`;
    html += `<pre>DESTINATION: ${iata || '____'}  TZ: ${tz}\nBREAK 1 START: ${formatInZone(g1StartMs, tz)}\nGROUP 1: ${formatInZone(g1StartMs, tz)} → ${formatInZone(g1EndMs, tz)}  (${group1Rest} min)\nBUFFER BEFORE MID: ${bufferBefore} min   MID SERVICE: ${midService} min   BUFFER AFTER MID: ${bufferAfter} min\nGROUP 2: ${formatInZone(g2StartMs, tz)} → ${formatInZone(g2EndMs, tz)}  (${group2Rest} min)\nLANDING SERVICE START: ${formatInZone(landingStartMs, tz)}  TOUCHDOWN: ${formatInZone(touchdownFinalMs, tz)}\n</pre>`;

    // Debug tiny table of intermediate numeric minutes
    html += `<details><summary>Intermediate numbers (debug)</summary>`;
    html += `<table><tr><th>Variable</th><th>Value</th></tr>`;
    html += `<tr><td>Break1 after now (min)</td><td>${break1AfterNow}</td></tr>`;
    html += `<tr><td>Break1 start (local)</td><td>${formatInZone(b1StartMs, tz)}</td></tr>`;
    html += `<tr><td>Landing start desired (local)</td><td>${formatInZone(touchdownFinalMs - (landingOffset*60000), tz)}</td></tr>`;
    html += `<tr><td>Landing start actual (local)</td><td>${formatInZone(landingStartMs, tz)}</td></tr>`;
    html += `<tr><td>T_total (min)</td><td>${T_total_min}</td></tr>`;
    html += `<tr><td>Midservice total (min)</td><td>${midservice_total}</td></tr>`;
    html += `<tr><td>Total rest minutes available</td><td>${totalRestMinutes}</td></tr>`;
    html += `</table></details>`;

    show(html);
  }

})();
</script>
</body>
</html>
